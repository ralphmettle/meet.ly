{% extends 'base.html' %}

{% block stylesheet %}
<link rel = 'stylesheet' href = '{{ url_for("static", filename = "css/welcome.css")}}'>
{% endblock %}

{% block head %}
{% endblock %}

{% block body %}
<div class="welcome-container">
    <div class="form-container">
        <form action="{{ url_for('welcome')}}" method="POST">
            <div class="header-container">
                <h1>
                    Welcome!
                </h1>
            </div>
            <div class="picture_upload-container">
                <label for="profile-picture">
                    Upload profile picture
                </Label>
                <input type="file" id="profile-picture" name="profile_picture">
            </div>
            <br></br>
            <div class="location_input-container">
                <div class="geolocation-container">
                    <button onclick="getLocation(event)">
                            Get current location
                    </button>
                </div>
                <div class="loading-indicator" id="loading-indicator"></div>
                <div class="manual_location-container">
                    <p>
                        Or manually input location.
                    </p>
                    <input type="text" id="location_autocomplete" name="location" placeholder="Enter your location">
                </div>
                <!-- Debug Mode elements -->
                <div class="debug_mode" id="debug_mode" style="display: none">
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <button type="button" id="debug_coords" onclick="toggleDebugButton()">
                        Show coordinates
                    </button>
                </div>
            </div>
            <button type="submit">Submit</button>
        </form>
    </div>
</div>

<br></br>
<a href="{{url_for('logout')}}">
    Logout
</a>

{% block scripts %}
<!-- Debug mode -->
<script>
    const debugMode = true;
    const debugElement = document.getElementById("debug_mode");

    if (debugMode) {
        debugElement.style.display = "block"
    } else {
        debugElement.style.display = "none"
    }


    function toggleDebugButton() {
        var lat = document.getElementById("latitude");
        var long = document.getElementById("longitude");
        var toggleDebugButton = document.getElementById("debug_coords");

        if (lat.type === "hidden") {
            lat.type = "text";
            long.type = "text";
            toggleDebugButton.textContent = "Hide coordinates";
        } else {
            lat.type = "hidden";
            long.type = "hidden";
            toggleDebugButton.textContent = "Show coordinates";
        }
    }
</script>

<!-- Script to handle location retrieval and debug button display -->
<script>
    function validateCoordinates(value) {
        parseFloat(value);
        return !isNaN(value) && value <= 90 && value >= -90; 
    }
    
    function getCoordinates(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;

        if (validateCoordinates(lat) && validateCoordinates(long)) {
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = long;
        } else {
            alert("Invalid coordinates. Please try again or input your location manually.");
        }
    }

    function getLocation(event) {
        event.preventDefault();
        const loadingIndicator = document.getElementById("loading-indicator");
        loadingIndicator.style.display = "block";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(getCoordinates);
        } else {
            alert("Geolocation is not supported by this browser. Please input your location manually.");
            loadingIndicator.style.display = "none";
        }
    }
</script>

<!-- Script to handle location input autocomplete -->
<script>
    let autocomplete;

    function initAutocomplete() {
        autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('location_autocomplete'),
            { 
                types: ['geocode'],
                componentRestrictions: {'country': ['gb']},
                fields: ['geometry']
            }
        );

        autocomplete.addListener('place_changed', getLocationInfo);

    function getLocationInfo() {
        var place = autocomplete.getPlace();
        document.getElementById("latitude").value = place.geometry.location.lat();
        document.getElementById("longitude").value = place.geometry.location.lng();
    }
}
</script>

<!-- Google Maps API script -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsqXAw5paGfj1xv-SvrJgOcaowqEo9W6Y&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}

{% endblock %}







<!-- A form on the page that handles uploading a profile picture image as well as input for user location -->
<!-- Need API for obtaining user geolocation information in the form of latitude and longitude-->
<!-- Need JS logic to process latitude and longitude data with OSM API-->
<!-- Need JS logic to dynamically update suggestion for the user's location if they manually input using OSM API-->
<!-- Reflect the latitude and longitude/manually inputted data as 'Town, City' -->

<!-- Edit the script to make it so that the location data is only submitted on form button submission -->
<!-- Move the script to a separate .js file for reference from /scripts -->


<!-- Implement another script to allow manual input, turning the above button into a text input field powered by OSM API for autocomplete -->
<!-- Needs to be revertible so that the user can choose to use geodata or for if they made a mistake -->

